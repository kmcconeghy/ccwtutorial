---
title: "Inference"
bibliography: references.bib
---

```{r }
#| label: setup
#| echo: false
#| message: false
#| 
library(here)

source(here('scripts', 'setup.R'), echo=F)
# Set seed for reproducibility
set.seed(42)

dta_c_panel = readRDS(here('dta', 'dta_cloned_panel.Rds'))
```

# Description of the cohort

If the design of the study includes a baseline period, "time zero" and two treatment strategies, with a grace period or interval where one strategy allows some time for treatment to occur then the presentation of group characteristics is a little different from the typical trial or cohort study.

There being two main periods: 1) Baseline time zero, 2) End of the grace period.

So here is one approach:

1.  Present the baseline characteristics for everyone (prior to cloning) at time zero.
2.  Present the characteristics for both treatment groups at the end of the grace period.

This would lead to a "Table 1" with three columns.

## Table 1

```{r }
#| label: tab-1
#| tbl-cap-location: top
#| tbl-cap: "Table 1. Example of presentation of characteristics of a CCW Cohort"
#| echo: FALSE
#| warning: FALSE

d_cbase = dta_c_panel %>%
  # Take one obs for the baseline column
  dplyr::filter(time==1 & assign==1 & censor==0) %>%
  summarize(N = n(),
            X = paste0(round(mean(X), 2), ' (', round(sd(X), 2), ')'),
            X_t = paste0(round(mean(X_t), 2), ' (', round(sd(X_t), 2), ')'),
            `Age (years)` = paste0(floor(mean(age)), ' (', floor(sd(age)), ')'),
            `Gender, % Female` = paste0(prettyNum(sum(female==1), big.mark = ','), 
                                        ' (', round(mean(female)*100,1), ')')) %>%
  t()

d_c0 = dta_c_panel %>%
  # End of grace period
  dplyr::filter(time==12 & assign==0 & censor==0) %>%
  summarize(N = n(),
            X = paste0(round(mean(X), 2), ' (', round(sd(X), 2), ')'),
            X_t = paste0(round(mean(X_t), 2), ' (', round(sd(X_t), 2), ')'),
            `Age (years)` = paste0(floor(mean(age)), ' (', floor(sd(age)), ')'),
            `Gender, % Female` = paste0(prettyNum(sum(female==1), big.mark = ','), 
                                        ' (', round(mean(female)*100,1), ')')) %>%
  t()
  
d_c1 = dta_c_panel %>%
  # End of grace period
  dplyr::filter(time==12 & assign==1 & censor==0) %>%
  summarize(N = n(),
            X = paste0(round(mean(X), 2), ' (', round(sd(X), 2), ')'),
            X_t = paste0(round(mean(X_t), 2), ' (', round(sd(X_t), 2), ')'),
            `Age (years)` = paste0(floor(mean(age)), ' (', floor(sd(age)), ')'),
            `Gender, % Female` = paste0(prettyNum(sum(female==1), big.mark = ','), 
                                        ' (', round(mean(female)*100,1), ')')) %>%
  t()
  

bind_cols(Variables = c('N', 'X', 'Xt', 'Age (years)', 'Gender, female'),
          `Baseline` = d_cbase, `Assign=0` = d_c0, `Assign=1` = d_c1) %>%
  kable(, align = 'c') %>%
  kable_styling() %>%
  add_header_above(c(" " = 2, "Uncensored at end of grace period" = 2))
```

## Presentation of weighted differences

Most analyses would provide the naive differences between groups, and then present some adjusted difference. Most commonly the standardized mean differences (aSMD) or a P-value from a univariate test (not recommended).

So you could add one column for the SMD to the "Table 1", but there are also other approaches such as reporting Mahalanobis distance.

### Computation of distances

### Table 1 with differences

```{r }


```

# Uncertainty estimates

Several steps in the analysis makes the assumptions of conventional standard errors invalid. The use of cloning or repeated use of persons across sequential target trial dates complicates the statistical properties of the estimand (due to correlated data), additionally the uncertainty in estimation of probability weights should be considered.

Currently, most researchers are using bootstrapping to obtain confidence limits via percentile method. It is critical that: 1. The bootstrapping step occur prior to sequential repeated sampling, cloning or estimation of weights 2. The bootstrap sampling with replacement must be at the cluster-level (person).

Also consider, bootstrapping may fail to produce valid estimates in cases of matching procedures, or penalized regression procedures.[@camponovo2015][@abadie2008] Other bootstrapping failures may arise due to limited sample size or values on the boundary of a parameter space.

## Bootstrapping

::: callout-note
A Poisson bootstrap procedure is used here, see:[Additional Topics](04_advanced.qmd) for some notes on this. 
:::

## Inference statistics

Inferential statistics

::: callout-note
These variables are generated independently, but in real-life would be correlated...
:::

# References
